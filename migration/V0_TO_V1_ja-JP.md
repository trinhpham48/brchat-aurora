# 移行ガイド（v0からv1）

すでにBedrock Chatを以前のバージョン（~`0.4.x`）で使用している場合、以下の手順に従って移行する必要があります。

## なぜこれを行う必要があるのでしょうか？

このメジャーアップデートには重要なセキュリティアップデートが含まれています。

- ベクターデータベース（Aurora PostgreSQL上のpgvector）のストレージが暗号化されるようになり、デプロイ時に置き換えが発生します。これにより、既存のベクターアイテムは削除されます。
- ボットを作成できるユーザーを制限するために、`CreatingBotAllowed` Cognitoユーザーグループを導入しました。現在の既存ユーザーはこのグループに属していないため、ボット作成機能を持たせたい場合は手動で権限を付与する必要があります。参照：[Bot Personalization](../../README.md#bot-personalization)

## 前提条件

[データベース移行ガイド](./DATABASE_MIGRATION_ja-JP.md)を読み、アイテムを復元する方法を確認してください。

## ステップ

### ベクターストアの移行

- ターミナルを開き、プロジェクトディレクトリに移動します
- デプロイしたいブランチをプルします。以下は目的のブランチ（この場合は`v1`）に切り替えて最新の変更をプルする方法です：

```sh
git fetch
git checkout v1
git pull origin v1
```

- DMSでアイテムを復元する場合は、パスワードローテーションを無効にし、データベースにアクセスするためのパスワードをメモすることを忘れないでください。移行スクリプト([migrate_v0_v1.py](./migrate_v0_v1.py))で復元する場合は、パスワードをメモする必要はありません。
- CloudFormationが既存のAuroraクラスターを削除できるように、すべての[公開API](../PUBLISH_API_ja-JP.md)を削除します。
- [npx cdk deploy](../README.md#deploy-using-cdk)を実行すると、Auroraクラスターの置き換えがトリガーされ、すべてのベクターアイテムが削除されます。
- [データベース移行ガイド](./DATABASE_MIGRATION_ja-JP.md)に従ってベクターアイテムを復元します。
- ユーザーが既存のボット（RAGボットなど）の知識を利用できることを確認します。

### CreatingBotAllowed権限の付与

- デプロイ後、すべてのユーザーは新しいボットを作成できなくなります。
- 特定のユーザーにボットの作成を許可したい場合は、管理コンソールまたはCLIを使用して、それらのユーザーを`CreatingBotAllowed`グループに追加します。
- ユーザーがボットを作成できるか確認します。ユーザーは再ログインが必要であることに注意してください。