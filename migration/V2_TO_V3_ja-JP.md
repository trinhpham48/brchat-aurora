# 移行ガイド（v2からv3へ）

## 要約

- V3では、きめ細かなアクセス権限制御とBot Store機能が導入され、DynamoDBスキーマの変更が必要になります
- **移行前にDynamoDBのConversationTableをバックアップしてください**
- リポジトリURLを`bedrock-claude-chat`から`bedrock-chat`に更新してください
- 移行スクリプトを実行して、データを新しいスキーマに変換してください
- すべてのボットと会話は新しい権限モデルで保持されます
- **重要: 移行プロセス中は、移行が完了するまでアプリケーションはすべてのユーザーが利用できなくなります。このプロセスは、データ量と開発環境のパフォーマンスによって異なりますが、通常約60分かかります。**
- **重要: 移行プロセス中に、公開されているすべてのAPIを削除する必要があります。**
- **警告: 移行プロセスは、すべてのボットの100%の成功を保証することはできません。手動で再作成が必要になった場合に備えて、重要なボット設定を移行前に文書化してください**

## はじめに

### V3の新機能

V3ではBedrock Chatに以下の重要な機能強化が導入されました:

1. **きめ細かいアクセス権限制御**: ユーザーグループベースのアクセス権限でボットへのアクセスを制御
2. **ボットストア**: 一元化されたマーケットプレイスを通じてボットの共有と発見が可能
3. **管理機能**: APIの管理、重要ボットのマーク付け、ボット使用状況の分析

これらの新機能により、DynamoDBスキーマの変更が必要となり、既存ユーザーに対してマイグレーションプロセスが必要となりました。

### このマイグレーションが必要な理由

新しいアクセス権限モデルとボットストア機能により、ボットデータの保存とアクセス方法の再構築が必要となりました。マイグレーションプロセスでは、既存のボットと会話をすべてのデータを保持したまま新しいスキーマに変換します。

> [!WARNING]
> サービス中断のお知らせ: **マイグレーション処理中は、すべてのユーザーがアプリケーションを利用できなくなります。** ユーザーがシステムにアクセスする必要のないメンテナンス時間帯にマイグレーションを実行することをお勧めします。アプリケーションは、マイグレーションスクリプトが正常に完了し、すべてのデータが新しいスキーマに適切に変換された後にのみ利用可能となります。このプロセスは、データ量と開発環境のパフォーマンスによって異なりますが、通常約60分かかります。

> [!IMPORTANT]
> マイグレーション実行前の注意: **マイグレーションプロセスは、特に古いバージョンで作成されたボットやカスタム設定されたボットについて、100%の成功を保証することはできません**。必要に応じて手動で再作成できるよう、重要なボット設定（指示、ナレッジソース、設定など）をマイグレーション開始前に文書化しておいてください。

## 移行プロセス

### V3でのボットの可視性に関する重要なお知らせ

V3では、**パブリック共有が有効になっているすべてのV2ボットがボットストアで検索可能になります。**機密情報を含むボットを検索可能にしたくない場合は、V3に移行する前にプライベートに設定することを検討してください。

### ステップ1：環境名の特定

この手順では、CloudFormationスタックの名前を識別するために`{YOUR_ENV_PREFIX}`を指定します。[複数環境のデプロイ](../../README.md#deploying-multiple-environments)機能を使用している場合は、移行する環境の名前に置き換えてください。使用していない場合は、空の文字列に置き換えてください。

### ステップ2：リポジトリURLの更新（推奨）

リポジトリ名が`bedrock-claude-chat`から`bedrock-chat`に変更されました。ローカルリポジトリを更新してください：

```bash
# 現在のリモートURLを確認
git remote -v

# リモートURLを更新
git remote set-url origin https://github.com/aws-samples/bedrock-chat.git

# 変更を確認
git remote -v
```

### ステップ3：最新のV2バージョンの確認

> [!WARNING]
> V3に移行する前に、必ずv2.10.0にアップデートする必要があります。**このステップをスキップすると、移行中にデータが失われる可能性があります。**

移行を開始する前に、最新のV2バージョン（**v2.10.0**）を実行していることを確認してください。これにより、V3にアップグレードする前に必要なすべてのバグ修正と改善が適用されます：

```bash
# 最新のタグを取得
git fetch --tags

# 最新のV2バージョンをチェックアウト
git checkout v2.10.0

# 最新のV2バージョンをデプロイ
cd cdk
npm ci
npx cdk deploy --all
```

### ステップ4：V2 DynamoDBテーブル名の記録

CloudFormationの出力からV2 ConversationTableの名前を取得します：

```bash
# V2 ConversationTable名を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableName'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

後で移行スクリプトで必要になるため、このテーブル名を安全な場所に保存してください。

### ステップ5：DynamoDBテーブルのバックアップ

先ほど記録したテーブル名を使用して、DynamoDB ConversationTableのバックアップを作成してください：

```bash
# V2テーブルのバックアップを作成
aws dynamodb create-backup \
  --no-cli-pager \
  --backup-name "BedrockChatV2Backup-$(date +%Y%m%d)" \
  --table-name YOUR_V2_CONVERSATION_TABLE_NAME

# バックアップのステータスが利用可能であることを確認
aws dynamodb describe-backup \
  --no-cli-pager \
  --query BackupDescription.BackupDetails \
  --backup-arn YOUR_BACKUP_ARN
```

### ステップ6：公開されているAPIをすべて削除

> [!IMPORTANT]
> V3をデプロイする前に、アップグレードプロセス中のCloudformation出力値の競合を避けるため、公開されているすべてのAPIを削除する必要があります。

1. 管理者としてアプリケーションにログインします
2. 管理セクションに移動し、「API管理」を選択します
3. 公開されているすべてのAPIのリストを確認します
4. 各APIの横にある削除ボタンをクリックして削除します

APIの公開と管理についての詳細は、[PUBLISH_API.md](../PUBLISH_API_ja-JP.md)、[ADMINISTRATOR.md](../ADMINISTRATOR_ja-JP.md)のドキュメントをそれぞれ参照してください。

### ステップ7：V3のプルとデプロイ

最新のV3コードをプルしてデプロイします：

```bash
git fetch
git checkout v3
cd cdk
npm ci
npx cdk deploy --all
```

> [!IMPORTANT]
> V3をデプロイすると、移行プロセスが完了するまでアプリケーションはすべてのユーザーが利用できなくなります。新しいスキーマは古いデータ形式と互換性がないため、次のステップで移行スクリプトを完了するまで、ユーザーはボットや会話にアクセスできなくなります。

### ステップ8：V3 DynamoDBテーブル名の記録

V3のデプロイ後、新しいConversationTableとBotTableの両方の名前を取得する必要があります：

```bash
# V3 ConversationTable名を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack

# V3 BotTable名を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='BotTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

> [!Important]
> 移行スクリプトで必要になるため、これらのV3テーブル名を先ほど保存したV2テーブル名と一緒に保存してください。

### ステップ9：移行スクリプトの実行

移行スクリプトはV2データをV3スキーマに変換します。まず、移行スクリプト`docs/migration/migrate_v2_v3.py`を編集してテーブル名とリージョンを設定します：

```python
# DynamoDBが配置されているリージョン
REGION = "ap-northeast-1" # あなたのリージョンに置き換えてください

V2_CONVERSATION_TABLE = "BedrockChatStack-DatabaseConversationTableXXXX" # ステップ4で記録した値に置き換えてください
V3_CONVERSATION_TABLE = "BedrockChatStack-DatabaseConversationTableV3XXXX" # ステップ8で記録した値に置き換えてください
V3_BOT_TABLE = "BedrockChatStack-DatabaseBotTableV3XXXXX" # ステップ8で記録した値に置き換えてください
```

次に、backendディレクトリからPoetryを使用してスクリプトを実行します：

> [!NOTE]
> Pythonの要件バージョンが3.13.0以降に変更されました（将来の開発で変更される可能性があります。pyproject.tomlを参照）。異なるPythonバージョンでvenvをインストールしている場合は、一度削除する必要があります。

```bash
# backendディレクトリに移動
cd backend

# まだ依存関係をインストールしていない場合はインストール
poetry install

# まずドライランを実行して何が移行されるかを確認
poetry run python ../docs/migration/migrate_v2_v3.py --dry-run

# 問題なければ実際の移行を実行
poetry run python ../docs/migration/migrate_v2_v3.py

# 移行が成功したことを確認
poetry run python ../docs/migration/migrate_v2_v3.py --verify-only
```

移行スクリプトは、移行プロセスの詳細を含むレポートファイルを現在のディレクトリに生成します。このファイルを確認して、すべてのデータが正しく移行されたことを確認してください。

#### 大量のデータの処理

ヘビーユーザーや大量のデータがある環境の場合、以下のアプローチを検討してください：

1. **ユーザーごとの移行**：大量のデータを持つユーザーの場合、一度に1人ずつ移行します：

   ```bash
   poetry run python ../docs/migration/migrate_v2_v3.py --users user-id-1 user-id-2
   ```

2. **メモリの考慮事項**：移行プロセスはデータをメモリにロードします。メモリ不足（OOM）エラーが発生した場合は：

   - 一度に1人のユーザーを移行する
   - より多くのメモリを持つマシンで移行を実行する
   - 移行をより小さなユーザーバッチに分割する

3. **移行の監視**：特に大規模なデータセットの場合、生成されたレポートファイルを確認して、すべてのデータが正しく移行されていることを確認してください。

### ステップ10：アプリケーションの確認

移行後、アプリケーションを開いて以下を確認します：

- すべてのボットが利用可能
- 会話が保持されている
- 新しい権限コントロールが機能している

### クリーンアップ（オプション）

移行が成功し、すべてのデータがV3で適切にアクセス可能であることを確認した後、コストを節約するためにV2会話テーブルを削除することができます：

```bash
# V2会話テーブルを削除（成功した移行を確認した後のみ）
aws dynamodb delete-table --table-name YOUR_V2_CONVERSATION_TABLE_NAME
```

> [!IMPORTANT]
> 重要なデータがすべてV3に正常に移行されたことを十分に確認してから、V2テーブルを削除してください。元のテーブルを削除した場合でも、ステップ2で作成したバックアップを移行後少なくとも数週間は保持することをお勧めします。

## V3 FAQ

### ボットのアクセスと権限

**Q: 使用中のボットが削除されたり、アクセス権限が削除された場合はどうなりますか？**
A: チャット時に認可がチェックされるため、即座にアクセスができなくなります。

**Q: ユーザーが削除された場合（例：従業員が退職）はどうなりますか？**
A: DynamoDBからそのユーザーIDをパーティションキー（PK）として持つすべてのアイテムを削除することで、完全にデータを削除できます。

**Q: essential（必須）の公開ボットの共有を無効にできますか？**
A: いいえ、管理者が先にボットをessentialでないと設定してから、共有を無効にする必要があります。

**Q: essential（必須）の公開ボットを削除できますか？**
A: いいえ、管理者が先にボットをessentialでないと設定してから、削除する必要があります。

### セキュリティと実装

**Q: ボットテーブルに行レベルセキュリティ（RLS）は実装されていますか？**
A: いいえ、アクセスパターンの多様性を考慮し、実装されていません。認可はボットへのアクセス時に実行され、会話履歴と比較してメタデータの漏洩リスクは最小限と考えられています。

**Q: APIを公開するための要件は何ですか？**
A: ボットが公開されている必要があります。

**Q: すべてのプライベートボットの管理画面は提供されますか？**
A: V3の初期リリースでは提供されません。ただし、必要に応じてユーザーIDでクエリを実行してアイテムを削除することは可能です。

**Q: 検索UXを改善するためのボットのタグ付け機能は提供されますか？**
A: V3の初期リリースでは提供されませんが、将来のアップデートでLLMベースの自動タグ付けが追加される可能性があります。

### 管理機能

**Q: 管理者は何ができますか？**
A: 管理者は以下のことができます：

- 公開ボットの管理（高コストボットの確認を含む）
- APIの管理
- 公開ボットをessentialとしてマーク

**Q: 部分的に共有されているボットをessentialにできますか？**
A: いいえ、公開ボットのみサポートしています。

**Q: ピン留めされたボットの優先順位を設定できますか？**
A: 初期リリースでは設定できません。

### 認可の設定

**Q: 認可の設定方法を教えてください。**
A:

1. Amazon Cognitoコンソールを開き、BrChatユーザープールでユーザーグループを作成
2. 必要に応じてユーザーをこれらのグループに追加
3. BrChatで、ボット共有設定時にアクセスを許可したいユーザーグループを選択

注：グループメンバーシップの変更を反映するには再ログインが必要です。変更はトークンの更新時に反映されますが、IDトークンの有効期間中（V3のデフォルトは30分、`cdk.json`または`parameter.ts`の`tokenValidMinutes`で設定可能）は反映されません。

**Q: ボットにアクセスするたびにCognitoに確認を行いますか？**
A: いいえ、不要なI/O操作を避けるため、JWTトークンを使用して認可をチェックします。

### 検索機能

**Q: ボット検索はセマンティック検索に対応していますか？**
A: いいえ、部分一致検索のみサポートしています。現在のOpenSearch Serverlessの制約（2025年3月時点）により、セマンティック検索（例：「automobile」→「car」、「EV」、「vehicle」）は利用できません。