# คู่มือการอัพเกรด (v1 เป็น v2)

## สรุปสั้นๆ

- **สำหรับผู้ใช้ v1.2 หรือเวอร์ชันก่อนหน้า**: อัปเกรดเป็น v1.4 และสร้างบอทของคุณใหม่โดยใช้ Knowledge Base (KB) หลังจากช่วงเปลี่ยนผ่าน เมื่อคุณยืนยันว่าทุกอย่างทำงานได้ตามที่คาดหวังกับ KB แล้ว ให้ดำเนินการอัปเกรดเป็น v2
- **สำหรับผู้ใช้ v1.3**: แม้ว่าคุณจะใช้ KB อยู่แล้ว **ขอแนะนำอย่างยิ่ง**ให้อัปเกรดเป็น v1.4 และสร้างบอทใหม่ หากคุณยังใช้ pgvector อยู่ ให้ย้ายโดยสร้างบอทใหม่โดยใช้ KB ใน v1.4
- **สำหรับผู้ใช้ที่ต้องการใช้ pgvector ต่อไป**: ไม่แนะนำให้อัปเกรดเป็น v2 หากคุณวางแผนที่จะใช้ pgvector ต่อ การอัปเกรดเป็น v2 จะลบทรัพยากรทั้งหมดที่เกี่ยวข้องกับ pgvector และจะไม่มีการสนับสนุนในอนาคต ให้ใช้ v1 ต่อไปในกรณีนี้
- โปรดทราบว่า **การอัปเกรดเป็น v2 จะส่งผลให้ทรัพยากรที่เกี่ยวข้องกับ Aurora ทั้งหมดถูกลบ** การอัปเดตในอนาคตจะมุ่งเน้นที่ v2 เท่านั้น โดย v1 จะถูกยกเลิกการสนับสนุน

## บทนำ

### สิ่งที่จะเกิดขึ้น

การอัปเดต v2 นำเสนอการเปลี่ยนแปลงครั้งสำคัญโดยแทนที่ pgvector บน Aurora Serverless และการฝัง ECS ด้วย [Amazon Bedrock Knowledge Bases](https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base.html) การเปลี่ยนแปลงนี้ไม่สามารถใช้งานร่วมกับเวอร์ชันก่อนหน้าได้

### เหตุผลที่โครงการนี้เลือกใช้ Knowledge Bases และยกเลิกการใช้ pgvector

มีหลายเหตุผลสำหรับการเปลี่ยนแปลงนี้:

#### เพิ่มความแม่นยำของ RAG

- Knowledge Bases ใช้ OpenSearch Serverless เป็นระบบหลังบ้าน ซึ่งช่วยให้สามารถค้นหาแบบไฮบริดได้ทั้งการค้นหาแบบข้อความเต็มและการค้นหาแบบเวกเตอร์ ส่งผลให้มีความแม่นยำที่ดีขึ้นในการตอบคำถามที่มีคำนามเฉพาะ ซึ่งเป็นจุดที่ pgvector มีปัญหา
- นอกจากนี้ยังรองรับตัวเลือกเพิ่มเติมสำหรับการปรับปรุงความแม่นยำของ RAG เช่น การแบ่งชิ้นและการแยกวิเคราะห์ขั้นสูง
- Knowledge Bases มีให้ใช้งานทั่วไปมาเกือบหนึ่งปีแล้วนับถึงเดือนตุลาคม 2024 โดยมีฟีเจอร์เพิ่มเติมเช่นการครอบคลุมเว็บ คาดว่าจะมีการอัปเดตในอนาคต ทำให้ง่ายต่อการนำฟังก์ชันขั้นสูงมาใช้ในระยะยาว ตัวอย่างเช่น แม้ว่าโครงการนี้ยังไม่ได้ใช้ฟีเจอร์เช่นการนำเข้าจาก S3 bucket ที่มีอยู่ (ซึ่งเป็นฟีเจอร์ที่มีการร้องขอบ่อย) ใน pgvector แต่ฟีเจอร์นี้รองรับอยู่แล้วใน KB (KnowledgeBases)

#### การบำรุงรักษา

- การตั้งค่า ECS + Aurora ปัจจุบันต้องพึ่งพาไลบรารีจำนวนมาก รวมถึงไลบรารีสำหรับการแยกวิเคราะห์ PDF การครอบคลุมเว็บ และการดึงคำบรรยายจาก YouTube ในทางกลับกัน โซลูชันแบบจัดการเช่น Knowledge Bases ช่วยลดภาระในการบำรุงรักษาทั้งสำหรับผู้ใช้และทีมพัฒนาของโครงการ

## กระบวนการย้าย (สรุป)

เราขอแนะนำอย่างยิ่งให้อัปเกรดเป็น v1.4 ก่อนที่จะย้ายไป v2 ใน v1.4 คุณสามารถใช้ทั้ง pgvector และบอท Knowledge Base ได้ ซึ่งช่วยให้มีช่วงเวลาในการสร้างบอท pgvector ที่มีอยู่ใหม่ใน Knowledge Base และตรวจสอบว่าทำงานได้ตามที่คาดหวัง แม้ว่าเอกสาร RAG จะยังคงเหมือนเดิม โปรดทราบว่าการเปลี่ยนแปลงแบ็กเอนด์เป็น OpenSearch อาจให้ผลลัพธ์ที่แตกต่างกันเล็กน้อย แม้ว่าโดยทั่วไปจะคล้ายกัน เนื่องจากความแตกต่างเช่นอัลกอริทึม k-NN

โดยการตั้งค่า `useBedrockKnowledgeBasesForRag` เป็น true ใน `cdk.json` คุณสามารถสร้างบอทโดยใช้ Knowledge Bases ได้ อย่างไรก็ตาม บอท pgvector จะกลายเป็นแบบอ่านอย่างเดียว ซึ่งป้องกันการสร้างหรือแก้ไขบอท pgvector ใหม่

![](../imgs/v1_to_v2_readonly_bot.png)

ใน v1.4 มีการแนะนำ [Guardrails for Amazon Bedrock](https://aws.amazon.com/jp/bedrock/guardrails/) เนื่องจากข้อจำกัดด้านภูมิภาคของ Knowledge Bases บักเก็ต S3 สำหรับอัปโหลดเอกสารจะต้องอยู่ในภูมิภาคเดียวกันกับ `bedrockRegion` เราแนะนำให้สำรองข้อมูลบักเก็ตเอกสารที่มีอยู่ก่อนการอัปเดต เพื่อหลีกเลี่ยงการอัปโหลดเอกสารจำนวนมากด้วยตนเองในภายหลัง (เนื่องจากมีฟังก์ชันการนำเข้าบักเก็ต S3)

## ขั้นตอนการย้าย (รายละเอียด)

ขั้นตอนจะแตกต่างกันขึ้นอยู่กับว่าคุณใช้ v1.2 หรือรุ่นก่อนหน้า หรือ v1.3

![](../imgs/v1_to_v2_arch.png)

### ขั้นตอนสำหรับผู้ใช้ v1.2 หรือรุ่นก่อนหน้า

1. **สำรองข้อมูล document bucket ที่มีอยู่ (ไม่จำเป็นแต่แนะนำให้ทำ)** หากระบบของคุณกำลังทำงานอยู่ เราขอแนะนำให้ทำขั้นตอนนี้ สำรองข้อมูล bucket ชื่อ `bedrockchatstack-documentbucketxxxx-yyyy` ตัวอย่างเช่น เราสามารถใช้ [AWS Backup](https://docs.aws.amazon.com/aws-backup/latest/devguide/s3-backups.html)

2. **อัปเดตเป็น v1.4**: ดึง tag v1.4 ล่าสุด แก้ไข `cdk.json` และ deploy ตามขั้นตอนดังนี้:

   1. ดึง tag ล่าสุด:
      ```bash
      git fetch --tags
      git checkout tags/v1.4.0
      ```
   2. แก้ไข `cdk.json` ดังนี้:
      ```json
      {
        ...,
        "useBedrockKnowledgeBasesForRag": true,
        ...
      }
      ```
   3. Deploy การเปลี่ยนแปลง:
      ```bash
      npx cdk deploy
      ```

3. **สร้างบอทใหม่**: สร้างบอทของคุณใหม่บน Knowledge Base โดยใช้คำจำกัดความเดียวกัน (เอกสาร, ขนาดชิ้นส่วน ฯลฯ) กับบอท pgvector หากคุณมีเอกสารจำนวนมาก การกู้คืนจากข้อมูลสำรองในขั้นตอนที่ 1 จะทำให้กระบวนการนี้ง่ายขึ้น สำหรับการกู้คืน เราสามารถใช้การกู้คืนแบบข้ามภูมิภาค สำหรับรายละเอียดเพิ่มเติม เยี่ยมชม [ที่นี่](https://docs.aws.amazon.com/aws-backup/latest/devguide/restoring-s3.html) ในการระบุ bucket ที่กู้คืน ให้ตั้งค่าส่วน `S3 Data Source` ดังนี้ โครงสร้างเส้นทางคือ `s3://<bucket-name>/<user-id>/<bot-id>/documents/` คุณสามารถตรวจสอบ user id ได้ที่ Cognito user pool และ bot id ที่แถบที่อยู่บนหน้าจอสร้างบอท

![](../imgs/v1_to_v2_KB_s3_source.png)

**โปรดทราบว่าบางฟีเจอร์ไม่สามารถใช้งานได้บน Knowledge Bases เช่น การครอบเว็บและการรองรับการถอดข้อความ YouTube (วางแผนที่จะรองรับตัวครอบเว็บ ([issue](https://github.com/aws-samples/bedrock-chat/issues/557)))** นอกจากนี้ โปรดทราบว่าการใช้ Knowledge Bases จะมีค่าใช้จ่ายทั้งสำหรับ Aurora และ Knowledge Bases ในระหว่างการเปลี่ยนผ่าน

4. **ลบ API ที่เผยแพร่**: API ที่เคยเผยแพร่ทั้งหมดจะต้องเผยแพร่ใหม่ก่อนที่จะ deploy v2 เนื่องจากการลบ VPC ในการทำเช่นนี้ คุณจะต้องลบ API ที่มีอยู่ก่อน การใช้[ฟีเจอร์การจัดการ API ของผู้ดูแลระบบ](../ADMINISTRATOR_th-TH.md)สามารถทำให้กระบวนการนี้ง่ายขึ้น เมื่อการลบ CloudFormation stacks `APIPublishmentStackXXXX` ทั้งหมดเสร็จสิ้น สภาพแวดล้อมจะพร้อมใช้งาน

5. **Deploy v2**: หลังจากปล่อย v2 ให้ดึงซอร์สที่ติด tag และ deploy ดังนี้ (จะสามารถทำได้เมื่อปล่อยแล้ว):
   ```bash
   git fetch --tags
   git checkout tags/v2.0.0
   npx cdk deploy
   ```

> [!Warning]
> หลังจาก deploy v2 **บอททั้งหมดที่มีคำนำหน้า [Unsupported, Read-only] จะถูกซ่อน** ตรวจสอบให้แน่ใจว่าคุณได้สร้างบอทที่จำเป็นใหม่ก่อนอัปเกรดเพื่อหลีกเลี่ยงการสูญเสียการเข้าถึง

> [!Tip]
> ระหว่างการอัปเดต stack คุณอาจพบข้อความซ้ำๆ เช่น: Resource handler returned message: "The subnet 'subnet-xxx' has dependencies and cannot be deleted." ในกรณีเช่นนี้ ให้ไปที่ Management Console > EC2 > Network Interfaces และค้นหา BedrockChatStack ลบอินเทอร์เฟซที่แสดงที่เกี่ยวข้องกับชื่อนี้เพื่อช่วยให้กระบวนการ deployment ราบรื่นขึ้น

### ขั้นตอนสำหรับผู้ใช้ v1.3

ตามที่กล่าวไว้ก่อนหน้านี้ ใน v1.4 Knowledge Bases จะต้องถูกสร้างใน bedrockRegion เนื่องจากข้อจำกัดของภูมิภาค ดังนั้นคุณจะต้องสร้าง KB ใหม่ หากคุณได้ทดสอบ KB ใน v1.3 แล้ว ให้สร้างบอทใหม่ใน v1.4 โดยใช้คำจำกัดความเดียวกัน ทำตามขั้นตอนที่ระบุไว้สำหรับผู้ใช้ v1.2