# คู่มือการย้ายเวอร์ชัน (v2 เป็น v3)

## สรุปสาระสำคัญ

- V3 แนะนำการควบคุมสิทธิ์แบบละเอียดและฟังก์ชัน Bot Store ซึ่งต้องมีการเปลี่ยนแปลงโครงสร้าง DynamoDB
- **สำรองข้อมูล DynamoDB ConversationTable ของคุณก่อนการย้ายข้อมูล**
- อัปเดต URL ของ repository จาก `bedrock-claude-chat` เป็น `bedrock-chat`
- เรียกใช้สคริปต์การย้ายข้อมูลเพื่อแปลงข้อมูลของคุณเป็นโครงสร้างใหม่
- บอทและการสนทนาทั้งหมดของคุณจะถูกเก็บรักษาไว้ด้วยโมเดลสิทธิ์แบบใหม่
- **สำคัญ: ในระหว่างกระบวนการย้ายข้อมูล แอปพลิเคชันจะไม่สามารถใช้งานได้สำหรับผู้ใช้ทั้งหมดจนกว่าการย้ายข้อมูลจะเสร็จสมบูรณ์ กระบวนการนี้โดยทั่วไปใช้เวลาประมาณ 60 นาที ขึ้นอยู่กับปริมาณข้อมูลและประสิทธิภาพของสภาพแวดล้อมการพัฒนาของคุณ**
- **สำคัญ: API ที่เผยแพร่ทั้งหมดจะต้องถูกลบในระหว่างกระบวนการย้ายข้อมูล**
- **คำเตือน: กระบวนการย้ายข้อมูลไม่สามารถรับประกันความสำเร็จ 100% สำหรับบอททั้งหมด โปรดบันทึกการตั้งค่าบอทที่สำคัญของคุณก่อนการย้ายข้อมูลในกรณีที่คุณต้องสร้างใหม่ด้วยตนเอง**

## บทนำ

### มีอะไรใหม่ใน V3

V3 นำเสนอการปรับปรุง Bedrock Chat ที่สำคัญ:

1. **การควบคุมสิทธิ์อย่างละเอียด**: ควบคุมการเข้าถึงบอทของคุณด้วยสิทธิ์ตามกลุ่มผู้ใช้
2. **Bot Store**: แชร์และค้นหาบอทผ่านตลาดกลาง
3. **ฟีเจอร์การจัดการ**: จัดการ API ทำเครื่องหมายบอทที่จำเป็น และวิเคราะห์การใช้งานบอท

ฟีเจอร์ใหม่เหล่านี้ต้องการการเปลี่ยนแปลงโครงสร้าง DynamoDB ซึ่งจำเป็นต้องมีกระบวนการย้ายข้อมูลสำหรับผู้ใช้ที่มีอยู่

### ทำไมการย้ายข้อมูลนี้จึงจำเป็น

โมเดลสิทธิ์ใหม่และฟังก์ชัน Bot Store ต้องการการปรับโครงสร้างวิธีการจัดเก็บและเข้าถึงข้อมูลบอท กระบวนการย้ายข้อมูลจะแปลงบอทและการสนทนาที่มีอยู่ของคุณไปยังโครงสร้างใหม่ในขณะที่รักษาข้อมูลทั้งหมดของคุณไว้

> [!WARNING]
> ประกาศการหยุดให้บริการ: **ในระหว่างกระบวนการย้ายข้อมูล แอปพลิเคชันจะไม่สามารถใช้งานได้สำหรับผู้ใช้ทั้งหมด** วางแผนที่จะดำเนินการย้ายข้อมูลนี้ในช่วงเวลาบำรุงรักษาเมื่อผู้ใช้ไม่จำเป็นต้องเข้าถึงระบบ แอปพลิเคชันจะสามารถใช้งานได้อีกครั้งหลังจากสคริปต์การย้ายข้อมูลเสร็จสมบูรณ์และข้อมูลทั้งหมดถูกแปลงเป็นโครงสร้างใหม่อย่างถูกต้อง กระบวนการนี้โดยทั่วไปใช้เวลาประมาณ 60 นาที ขึ้นอยู่กับปริมาณข้อมูลและประสิทธิภาพของสภาพแวดล้อมการพัฒนาของคุณ

> [!IMPORTANT]
> ก่อนดำเนินการย้ายข้อมูล: **กระบวนการย้ายข้อมูลไม่สามารถรับประกันความสำเร็จ 100% สำหรับบอททั้งหมด** โดยเฉพาะบอทที่สร้างด้วยเวอร์ชันเก่าหรือมีการกำหนดค่าแบบกำหนดเอง โปรดบันทึกการกำหนดค่าบอทที่สำคัญของคุณ (คำแนะนำ แหล่งความรู้ การตั้งค่า) ก่อนเริ่มกระบวนการย้ายข้อมูลในกรณีที่คุณต้องสร้างใหม่ด้วยตนเอง

## กระบวนการย้ายข้อมูล

### ประกาศสำคัญเกี่ยวกับการมองเห็นบอทใน V3

ใน V3 **บอท v2 ทั้งหมดที่เปิดใช้งานการแชร์สาธารณะจะสามารถค้นหาได้ใน Bot Store** หากคุณมีบอทที่มีข้อมูลที่ละเอียดอ่อนที่คุณไม่ต้องการให้ค้นพบได้ ควรพิจารณาตั้งค่าเป็นส่วนตัวก่อนย้ายไปยัง V3

### ขั้นตอนที่ 1: ระบุชื่อสภาพแวดล้อมของคุณ

ในขั้นตอนนี้ `{YOUR_ENV_PREFIX}` ถูกระบุเพื่อระบุชื่อของ CloudFormation Stacks ของคุณ หากคุณใช้ฟีเจอร์ [Deploying Multiple Environments](../../README.md#deploying-multiple-environments) ให้แทนที่ด้วยชื่อของสภาพแวดล้อมที่จะย้าย หากไม่ได้ใช้ ให้แทนที่ด้วยสตริงว่าง

### ขั้นตอนที่ 2: อัปเดต URL ของ Repository (แนะนำ)

repository ได้ถูกเปลี่ยนชื่อจาก `bedrock-claude-chat` เป็น `bedrock-chat` อัปเดต repository ในเครื่องของคุณ:

```bash
# Check your current remote URL
git remote -v

# Update the remote URL
git remote set-url origin https://github.com/aws-samples/bedrock-chat.git

# Verify the change
git remote -v
```

### ขั้นตอนที่ 3: ตรวจสอบให้แน่ใจว่าคุณใช้เวอร์ชัน V2 ล่าสุด

> [!WARNING]
> คุณต้องอัปเดตเป็น v2.10.0 ก่อนย้ายไปยัง V3 **การข้ามขั้นตอนนี้อาจทำให้ข้อมูลสูญหายระหว่างการย้าย**

ก่อนเริ่มการย้าย ตรวจสอบให้แน่ใจว่าคุณกำลังใช้งานเวอร์ชันล่าสุดของ V2 (**v2.10.0**) เพื่อให้แน่ใจว่าคุณมีการแก้ไขข้อบกพร่องและการปรับปรุงที่จำเป็นทั้งหมดก่อนอัปเกรดเป็น V3:

```bash
# Fetch the latest tags
git fetch --tags

# Checkout the latest V2 version
git checkout v2.10.0

# Deploy the latest V2 version
cd cdk
npm ci
npx cdk deploy --all
```

### ขั้นตอนที่ 4: บันทึกชื่อตาราง DynamoDB V2 ของคุณ

รับชื่อ ConversationTable V2 จากผลลัพธ์ของ CloudFormation:

```bash
# Get the V2 ConversationTable name
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableName'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

ตรวจสอบให้แน่ใจว่าได้บันทึกชื่อตารางนี้ไว้ในที่ปลอดภัย เนื่องจากคุณจะต้องใช้มันสำหรับสคริปต์การย้ายข้อมูลในภายหลัง

### ขั้นตอนที่ 5: สำรองข้อมูลตาราง DynamoDB ของคุณ

ก่อนดำเนินการต่อ ให้สร้างการสำรองข้อมูลของตาราง ConversationTable DynamoDB โดยใช้ชื่อที่คุณเพิ่งบันทึกไว้:

```bash
# Create a backup of your V2 table
aws dynamodb create-backup \
  --no-cli-pager \
  --backup-name "BedrockChatV2Backup-$(date +%Y%m%d)" \
  --table-name YOUR_V2_CONVERSATION_TABLE_NAME

# Check the backup status is available
aws dynamodb describe-backup \
  --no-cli-pager \
  --query BackupDescription.BackupDetails \
  --backup-arn YOUR_BACKUP_ARN
```

### ขั้นตอนที่ 6: ลบ API ที่เผยแพร่ทั้งหมด

> [!IMPORTANT]
> ก่อนที่จะ deploy V3 คุณต้องลบ API ที่เผยแพร่ทั้งหมดเพื่อหลีกเลี่ยงความขัดแย้งของค่าผลลัพธ์ Cloudformation ในระหว่างกระบวนการอัปเกรด

1. เข้าสู่ระบบแอปพลิเคชันของคุณในฐานะผู้ดูแลระบบ
2. ไปที่ส่วน Admin และเลือก "API Management"
3. ตรวจสอบรายการ API ที่เผยแพร่ทั้งหมด
4. ลบแต่ละ API ที่เผยแพร่โดยคลิกปุ่มลบข้างๆ

คุณสามารถหาข้อมูลเพิ่มเติมเกี่ยวกับการเผยแพร่และการจัดการ API ได้ในเอกสาร [PUBLISH_API.md](../PUBLISH_API_th-TH.md), [ADMINISTRATOR.md](../ADMINISTRATOR_th-TH.md) ตามลำดับ

### ขั้นตอนที่ 7: ดึงโค้ด V3 และ Deploy

ดึงโค้ด V3 ล่าสุดและ deploy:

```bash
git fetch
git checkout v3
cd cdk
npm ci
npx cdk deploy --all
```

> [!IMPORTANT]
> เมื่อคุณ deploy V3 แล้ว แอปพลิเคชันจะไม่สามารถใช้งานได้สำหรับผู้ใช้ทั้งหมดจนกว่ากระบวนการย้ายข้อมูลจะเสร็จสมบูรณ์ สคีมาใหม่ไม่สามารถใช้งานร่วมกับรูปแบบข้อมูลเก่าได้ ดังนั้นผู้ใช้จะไม่สามารถเข้าถึงบอทหรือการสนทนาของพวกเขาได้จนกว่าคุณจะดำเนินการสคริปต์การย้ายข้อมูลในขั้นตอนถัดไปให้เสร็จสมบูรณ์

### ขั้นตอนที่ 8: บันทึกชื่อตาราง DynamoDB V3 ของคุณ

หลังจาก deploy V3 คุณต้องรับชื่อตาราง ConversationTable และ BotTable ใหม่:

```bash
# Get the V3 ConversationTable name
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack

# Get the V3 BotTable name
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='BotTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

> [!Important]
> ตรวจสอบให้แน่ใจว่าได้บันทึกชื่อตาราง V3 เหล่านี้พร้อมกับชื่อตาราง V2 ที่คุณบันทึกไว้ก่อนหน้านี้ เนื่องจากคุณจะต้องใช้ทั้งหมดสำหรับสคริปต์การย้ายข้อมูล

### ขั้นตอนที่ 9: เรียกใช้สคริปต์การย้ายข้อมูล

สคริปต์การย้ายข้อมูลจะแปลงข้อมูล V2 ของคุณเป็นสคีมา V3 ก่อนอื่นให้แก้ไขสคริปต์การย้ายข้อมูล `docs/migration/migrate_v2_v3.py` เพื่อตั้งค่าชื่อตารางและภูมิภาคของคุณ:

```python
# Region where dynamodb is located
REGION = "ap-northeast-1" # Replace with your region

V2_CONVERSATION_TABLE = "BedrockChatStack-DatabaseConversationTableXXXX" # Replace with your  value recorded in Step 4
V3_CONVERSATION_TABLE = "BedrockChatStack-DatabaseConversationTableV3XXXX" # Replace with your  value recorded in Step 8
V3_BOT_TABLE = "BedrockChatStack-DatabaseBotTableV3XXXXX" # Replace with your  value recorded in Step 8
```

จากนั้นเรียกใช้สคริปต์โดยใช้ Poetry จากไดเรกทอรี backend:

> [!NOTE]
> เวอร์ชันข้อกำหนด Python ถูกเปลี่ยนเป็น 3.13.0 หรือใหม่กว่า (อาจมีการเปลี่ยนแปลงในการพัฒนาในอนาคต ดู pyproject.toml) หากคุณมี venv ที่ติดตั้งด้วย Python เวอร์ชันอื่น คุณจะต้องลบออกก่อน

```bash
# Navigate to the backend directory
cd backend

# Install dependencies if you haven't already
poetry install

# Run a dry run first to see what would be migrated
poetry run python ../docs/migration/migrate_v2_v3.py --dry-run

# If everything looks good, run the actual migration
poetry run python ../docs/migration/migrate_v2_v3.py

# Verify the migration was successful
poetry run python ../docs/migration/migrate_v2_v3.py --verify-only
```

สคริปต์การย้ายข้อมูลจะสร้างไฟล์รายงานในไดเรกทอรีปัจจุบันของคุณพร้อมรายละเอียดเกี่ยวกับกระบวนการย้ายข้อมูล ตรวจสอบไฟล์นี้เพื่อให้แน่ใจว่าข้อมูลทั้งหมดของคุณถูกย้ายอย่างถูกต้อง

#### การจัดการกับข้อมูลขนาดใหญ่

สำหรับสภาพแวดล้อมที่มีผู้ใช้จำนวนมากหรือมีข้อมูลจำนวนมาก ให้พิจารณาวิธีการเหล่านี้:

1. **ย้ายผู้ใช้ทีละคน**: สำหรับผู้ใช้ที่มีข้อมูลจำนวนมาก ให้ย้ายทีละคน:

   ```bash
   poetry run python ../docs/migration/migrate_v2_v3.py --users user-id-1 user-id-2
   ```

2. **การพิจารณาเรื่องหน่วยความจำ**: กระบวนการย้ายข้อมูลจะโหลดข้อมูลเข้าหน่วยความจำ หากคุณพบข้อผิดพลาด Out-Of-Memory (OOM) ลองทำดังนี้:

   - ย้ายผู้ใช้ทีละคน
   - เรียกใช้การย้ายข้อมูลบนเครื่องที่มีหน่วยความจำมากกว่า
   - แบ่งการย้ายข้อมูลเป็นชุดผู้ใช้ที่เล็กลง

3. **ตรวจสอบการย้ายข้อมูล**: ตรวจสอบไฟล์รายงานที่สร้างขึ้นเพื่อให้แน่ใจว่าข้อมูลทั้งหมดถูกย้ายอย่างถูกต้อง โดยเฉพาะอย่างยิ่งสำหรับชุดข้อมูลขนาดใหญ่

### ขั้นตอนที่ 10: ตรวจสอบแอปพลิเคชัน

หลังจากการย้ายข้อมูล เปิดแอปพลิเคชันของคุณและตรวจสอบ:

- บอททั้งหมดของคุณพร้อมใช้งาน
- การสนทนาถูกเก็บรักษาไว้
- การควบคุมสิทธิ์ใหม่ทำงานได้

### การทำความสะอาด (ตัวเลือก

## คำถามที่พบบ่อย V3

### การเข้าถึงบอทและสิทธิ์การใช้งาน

**Q: จะเกิดอะไรขึ้นถ้าบอทที่ฉันใช้อยู่ถูกลบหรือสิทธิ์การเข้าถึงของฉันถูกเพิกถอน?**
A: การตรวจสอบสิทธิ์จะทำในขณะแชท ดังนั้นคุณจะสูญเสียการเข้าถึงทันที

**Q: จะเกิดอะไรขึ้นถ้าผู้ใช้ถูกลบ (เช่น พนักงานลาออก)?**
A: ข้อมูลทั้งหมดของพวกเขาสามารถลบได้โดยการลบรายการทั้งหมดจาก DynamoDB ที่มี user ID เป็นคีย์หลัก (PK)

**Q: ฉันสามารถปิดการแชร์สำหรับบอทสาธารณะที่จำเป็นได้หรือไม่?**
A: ไม่ได้ ผู้ดูแลระบบต้องทำเครื่องหมายบอทเป็นไม่จำเป็นก่อนที่จะปิดการแชร์

**Q: ฉันสามารถลบบอทสาธารณะที่จำเป็นได้หรือไม่?**
A: ไม่ได้ ผู้ดูแลระบบต้องทำเครื่องหมายบอทเป็นไม่จำเป็นก่อนที่จะลบได้

### ความปลอดภัยและการใช้งาน

**Q: มีการใช้ความปลอดภัยระดับแถว (RLS) สำหรับตารางบอทหรือไม่?**
A: ไม่มี เนื่องจากความหลากหลายของรูปแบบการเข้าถึง การตรวจสอบสิทธิ์จะทำเมื่อเข้าถึงบอท และความเสี่ยงของการรั่วไหลของข้อมูลเมตาถือว่าน้อยเมื่อเทียบกับประวัติการสนทนา

**Q: มีข้อกำหนดอะไรบ้างในการเผยแพร่ API?**
A: บอทต้องเป็นสาธารณะ

**Q: จะมีหน้าจอจัดการสำหรับบอทส่วนตัวทั้งหมดหรือไม่?**
A: ไม่มีในการเปิดตัว V3 แรก อย่างไรก็ตาม รายการยังสามารถลบได้โดยการค้นหาด้วย user ID ตามต้องการ

**Q: จะมีฟังก์ชันการติดแท็กบอทเพื่อประสบการณ์การค้นหาที่ดีขึ้นหรือไม่?**
A: ไม่มีในการเปิดตัว V3 แรก แต่อาจมีการเพิ่มการติดแท็กอัตโนมัติด้วย LLM ในการอัปเดตในอนาคต

### การดูแลระบบ

**Q: ผู้ดูแลระบบสามารถทำอะไรได้บ้าง?**
A: ผู้ดูแลระบบสามารถ:

- จัดการบอทสาธารณะ (รวมถึงตรวจสอบบอทที่มีต้นทุนสูง)
- จัดการ API
- ทำเครื่องหมายบอทสาธารณะเป็นจำเป็น

**Q: ฉันสามารถทำให้บอทที่แชร์บางส่วนเป็นบอทจำเป็นได้หรือไม่?**
A: ไม่ได้ รองรับเฉพาะบอทสาธารณะเท่านั้น

**Q: ฉันสามารถกำหนดลำดับความสำคัญสำหรับบอทที่ปักหมุดได้หรือไม่?**
A: ไม่สามารถทำได้ในการเปิดตัวครั้งแรก

### การกำหนดค่าการตรวจสอบสิทธิ์

**Q: ฉันจะตั้งค่าการตรวจสอบสิทธิ์อย่างไร?**
A:

1. เปิดคอนโซล Amazon Cognito และสร้างกลุ่มผู้ใช้ใน BrChat user pool
2. เพิ่มผู้ใช้ในกลุ่มเหล่านี้ตามต้องการ
3. ใน BrChat เลือกกลุ่มผู้ใช้ที่คุณต้องการอนุญาตให้เข้าถึงเมื่อกำหนดค่าการตั้งค่าการแชร์บอท

หมายเหตุ: การเปลี่ยนแปลงสมาชิกกลุ่มต้องเข้าสู่ระบบใหม่จึงจะมีผล การเปลี่ยนแปลงจะมีผลเมื่อมีการรีเฟรชโทเค็น แต่ไม่ใช่ในระหว่างช่วงเวลาที่ ID token ยังใช้งานได้ (ค่าเริ่มต้น 30 นาทีใน V3 สามารถกำหนดค่าได้โดย `tokenValidMinutes` ใน `cdk.json` หรือ `parameter.ts`)

**Q: ระบบตรวจสอบกับ Cognito ทุกครั้งที่มีการเข้าถึงบอทหรือไม่?**
A: ไม่ การตรวจสอบสิทธิ์จะใช้โทเค็น JWT เพื่อหลีกเลี่ยงการดำเนินการ I/O ที่ไม่จำเป็น

### ฟังก์ชันการค้นหา

**Q: การค้นหาบอทรองรับการค้นหาเชิงความหมายหรือไม่?**
A: ไม่ รองรับเฉพาะการจับคู่ข้อความบางส่วนเท่านั้น การค้นหาเชิงความหมาย (เช่น "automobile" → "car", "EV", "vehicle") ไม่สามารถใช้งานได้เนื่องจากข้อจำกัดของ OpenSearch Serverless ในปัจจุบัน (มีนาคม 2025)